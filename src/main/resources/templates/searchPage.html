<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<script src="https://code.jquery.com/jquery-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .text-truncate{
        white-space: wrap;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        margin-bottom: 0.1rem;
    }
    .text-truncate.info{
        -webkit-line-clamp: 1;
        word-break: break-all;
    }
    .card-box-a{
        text-decoration-line: none;
    }
    a:hover {
        text-decoration: none;
    }
    .card-body{
        padding: 0.5rem;
    }
    .discount{
        color: white;
    }
    .fixed-price{

    }
    .items{
        display: inline-block;
    }
    .fs-4{
        margin: 0;
    }
    .fs-7{
        font-size: 0.85rem;
    }
    .word-box {
        height: 4rem;
    }
    .word-box.info {
        height: 1.2rem;
    }
    .badge {
        --bs-badge-padding-x: 0.4em;
        --bs-badge-padding-y: 0.25em;
    }
    .text-danger.sold-out{
    --bs-badge-padding-x: 0.1em;
    --bs-badge-padding-y: 0.1em;
    }
    h6.card-title{
        display: inline-block;
    }
    .graph{
        z-index: 99;
        width: 350px !important;
        height: 210px !important;
        background-color: rgb(247, 247, 247);
        display: none;
        border-radius: 10px;
    }
    .hidden{
        display:none;
    }
</style>
<body>
<header th:replace="fragments/header :: header"></header>

<main th:replace="fragments/main :: search-product"></main>

<footer th:replace="fragments/footer :: footer"></footer>

</body>
<script>
    function chart(num, dates){
        let query = '.chart-'+num
        let ctx = $(query)

        let labels = dates.map(date => {
            let parts = date.priceDate.split('-')
            return parts[1] +"/"+ parts[2]
        })
        let data = dates.map(date => date.dailyPrice);

        let item_query = '.item-'+num
        let q = '.graph-'+num
        $(q).css('left', ($(item_query).offset().left - 260) + 'px');
        $(q).css('top', ($(item_query).offset().top + 5) + 'px');

        let plugins = {
            id: 'pluginID',

            afterDraw: function(chart) {
                const {ctx, chartArea: {top, right, width}} = chart;
                // ctx: 캔버스의 그리기 컨텍스트
                // chartArea: 차트가 그려지는 영역의 좌표와 크기 정보

                // 범례의 위치 및 크기를 설정합니다.
                chart.legend.left = right - chart.legend.width - 10; // 차트 오른쪽 끝에서 범례의 너비만큼 왼쪽으로 이동
                chart.legend.top = top + 5; // 차트 상단에서 조금 아래로 이동
                chart.legend.fullWidth = false; // 전체 너비 사용을 비활성화

                // 범례를 다시 그립니다.
                chart.legend.draw();
            }
        };

        let myLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '일별 가격',
                    data: data,
                    fill: false,
                    borderColor: 'rgb(13 110 253)',
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    tooltip: {

                    },
                    legend: {
<!--                        display: false,-->
<!--                        position: 'left',-->
                        labels: {
                            font: {
                                size: 9
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            stepSize: 2000,
                            font: {
                                size: 10
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        ticks: {
                            font: {
<!--                                style: 'Courier New',-->
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    }



    function ajax(query, selectedOption){
        $.ajax({
            url: '/search',
            type: 'GET',
            data: {
                query: query,
                options: selectedOption
            } ,
            success: function() {
                window.location.href = "search?query="+query+"&options="+selectedOption;
            }

        })
    }

    $(document).ready(function() {


        function items_hover(num, w) {
            let query = '.graph-'+num
            console.log(query)
            if(w == 0){
                $(query).css('display', 'block');
            } else
                $(query).css('display', 'none');

        }

    $(document).on('mouseenter', '.items', function() {
        let index = $('.items').index(this)
        let w = 0
        console.log("aaa")
        items_hover(index, w)
    }).on('mouseleave', '.items', function() {
        let index = $('.items').index(this)
        let w = 1
        items_hover(index, w)
    })

        $('#search-btn').click(function() {
            let query = $('#query').val()
            let selectedOption = $('input[name="options"]:checked').val()
            if(query === ''){
<!--                $('#query').val() = ''-->
                alert("검색어를 입력해주세요")
            } else{
                ajax(query, selectedOption)
            }
        })

        let options = document.querySelectorAll('input[name="options"]')
        for(let i = 0 ; i<options.length ;i++){
            options[i].addEventListener('click', function() {
                let query = $('#search-result').text()
                let selectedOption = $('input[name="options"]:checked').val()
                ajax(query, selectedOption)
            })
        }

        let pageNumber = 0;
        let busy = false;

        let array_num = []
        let array_json = []

        function loadMoreProducts() {
            let num = 0;

            if (busy) return;
            busy = true;

            pageNumber++;
            $.ajax({
                url: '/searching',
                type: 'GET',
                data: {
                    query: $('#search-result').text(),
                    options: $('input[name="options"]:checked').val(),
                    page: pageNumber,
                    size: 36
                },
                dataType: 'json',
                success: function(data) {
                    if (data.content.length > 0) {
                        data.content.forEach(function(product) {
                            let hiddenClass = product.dailyPrice != 0 && product.itemQuantity != '품절' ? '' : 'hidden';
                            console.log(hiddenClass)
                            let items = $('.items').length
                            let productHtml = `
                                <div class="items mx-1 my-2 z-index-0 ${hiddenClass}">
                                    <a href="${product.address}" class="card-box-a item-`+ (items+num) +`">
                                        <div class="card" style="width: 13rem;">
                                            <img src="${product.itemImg}" class="card-img-top" style="height: 10rem;" alt="img">
                                            <div class="card-body">
                                                ${product.discountRate === 0 ?
                                                    '<span class="badge text-bg-secondary">-</span>' :
                                                    `<span class="badge text-bg-primary discount"> - ${product.discountRate}%</span>`}
                                                ${product.fixedPrice !== 0 ?
                                                    `<span class="badge text-decoration-line-through text-secondary">${product.fixedPrice.toLocaleString()}원</span>` : ''}
                                                ${product.deliveryType === '로켓배송' ?
                                                    `<span class="badge text-info">${product.deliveryType}</span>` : ''}
                                                    <div>
                                                <h6 class="card-title text-danger my-2 fw-bold">${product.dailyPrice.toLocaleString()} 원</h6>
                                                ${product.itemQuantity !== '' ?
                                                    '<span class="badge text-bg-danger">품절 임박</span>' : ''}
                                                    </div>
                                                <p class="text-dark text-truncate word-box fs-7" title="${product.pname}">${product.pname}</p>
                                                <p class="text-secondary text-truncate info word-box fs-7" title="${product.detailInfo}">${product.detailInfo}</p>
                                            </div>
                                        </div>
                                    </a>
                                    <div class="position-absolute p-1 graph graph-`+ (items+num) +`">
                                        <canvas class="chart-`+ (items+num) +`"></canvas>
                                    </div>

                                </div>`
                                $("#product-body").append(productHtml);
                                array_num.push((items+num))
                                array_json.push(product.productInfoByDates)


                            })
                        busy = false
                    }

                    for(let i = 0 ; i<array_num.length ;i++)
                        chart(array_num[i], array_json[i])
                    array_num = []
                    array_json = []
                },
                error: function(xhr, status, error) {
                    console.log('Error fetching data:', error);
                    busy = false;
                }
            })
        }
        $(window).scroll(function() {
            if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                loadMoreProducts();
            }
        });


    })


    let searchParams = new URLSearchParams(window.location.search)
    let option = document.querySelectorAll('input[name = "options"]')
    if(option[searchParams.get('options')] === undefined){
        option[0].checked = true
    } else{
        option[searchParams.get('options')].checked = true
    }


</script>
</html>